<!-- 
移到空格		1,3
移到非空		5,1,3
移到非空又回	5,4,1,3
修正1:實格拖曳到空格時，放到兩格之間，方塊消失bug。step 1,2 
修正2:實格拖曳到實格時，交換後又拖回兩格之間，格位錯亂。step 3,4,5,6 
修正3:雙點擊時，刪除方塊。step 7
-->

<style>
table {
  border-collapse: separate;
  border-spacing: 15px;
}
.droppable {
  width: 100px;
  height: 100px;
  background: grey;
  font-size: 15pt;
  font-family: Helvetical, Arial, sans-serif;
  color: white;
  line-height: 100px;
  vertical-align: middle;
  text-align: center;
}

.draggable {
  width: 100px;
  height: 100px;
  background: green;
}

.placeholder {
  background: red;
}
</style>

<table>
  <tr>
    <td class="droppable">
      <div class="draggable">1</div>
    </td>
    <td class="droppable">
    </td>
    <td class="droppable">
      <div class="draggable">2</div>
    </td>
  </tr>
  <tr>
    <td class="droppable">
    </td>
    <td class="droppable">
      <div class="draggable">3</div>
    </td>
    <td class="droppable">
    </td>
  </tr>
  <tr>
    <td class="droppable">
      <div class="draggable">4</div>
    </td>
    <td class="droppable">
      <div class="draggable">5</div>
    </td>
    <td class="droppable">
      <div class="draggable">6</div>
    </td>
  </tr>
</table>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<script>
var dragLastPlace;
var movedLastPlace;
var dropPlace;
var isChange;
$('.draggable').draggable({
  placeholder: 'placeholder',
  zIndex: 1000,
  containment: 'table',
  helper: function(evt) {
    var that = $(this).clone().get(0);
    $(this).hide();
    return that;
  },
  start: function(evt, ui) {
    dragLastPlace = $(this).parent();
  },
  cursorAt: {
    top: 20,
    left: 20
  }
});

$('.droppable').droppable({
  hoverClass: 'placeholder',
  drop: function(evt, ui) {
	var draggable = ui.draggable;
    var droppable = this;
console.log('1');
	//console.log($(droppable).context.nodeName);
	dropPlace = 'td'; //step 1
	
    if ($(droppable).children('.draggable:visible:not(.ui-draggable-dragging)').length > 0) {
      $(droppable).children('.draggable:visible:not(.ui-draggable-dragging)').detach().prependTo(dragLastPlace);
console.log('2');
    }

    $(draggable).detach().css({top: 0, left: 0}).prependTo($(droppable)).show();
    movedLastPlace = undefined;
console.log('3');	
  },
  over: function(evt, ui) {
    var draggable = ui.draggable;
    var droppable = this;

    if (movedLastPlace) {
      $(dragLastPlace).children().not(draggable).detach().prependTo(movedLastPlace);
	  isChange = false; //step 3
console.log('4');	  
	}

    if ($(droppable).children('.draggable:visible:not(.ui-draggable-dragging)').length > 0) {
      $(droppable).children('.draggable:visible').detach().prependTo(dragLastPlace);
      movedLastPlace = $(droppable);
	  isChange = true; //step 4
console.log('5');	  
	}
  }
});

//step 2
$('table').droppable({
	drop: function(evt, ui) {
	    var draggable = ui.draggable;
		var droppable = this;
		//console.log($(droppable).context.nodeName);
		
		if(dropPlace != 'td') {
			console.log('go back');
			//如果是5則退回movedLastPlace,否則執行下列
			if(isChange)
				$(draggable).prependTo(movedLastPlace).show(); //step 5	
			else
				$(draggable).prependTo($(draggable).parent()).show();			
		}
		isChange = false; //step 6
		dropPlace = '';
	}
});

//step 7
$('.draggable').dblclick(function(){
	$(this).select();
	if(confirm('確定刪除 '+ $(this).text() +' ?')) 
		$(this).detach();
});
</script>